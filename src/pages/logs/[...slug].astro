---
import { getCollection, getEntry, render } from "astro:content";
import readingTime from "reading-time";
import BackAnchor from "@/components/ui/BackAnchor.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import LogLayout from "@/layouts/LogLayout.astro";

function generateSlug(title: string): string {
    return title
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^\w\-]/g, "");
}

export async function getStaticPaths() {
    const logs = await getCollection("logs");
    return logs.map((entry) => ({
        params: { slug: entry.data.slug || generateSlug(entry.data.title) },
    }));
}

const { slug } = Astro.params;
if (!slug) {
    throw new Error("Missing slug");
}

const log = await getEntry("logs", slug);
if (!log) {
    throw new Error(`Log not found for slug: ${slug}`);
}
const logData = log.data;

const { Content, headings } = await render(log);

const author = await getEntry(logData.author.collection, logData.author.id);
if (!author) {
    throw new Error(`Author not found for slug: ${logData.author.id}`);
}
const authorData = author.data;

const stats = readingTime(log.body ?? "");
---

<BaseLayout>
    <div class="prose-container">
        <BackAnchor href="/logs" />
        <div class="py-8">
            <LogLayout log={log} author={author} stats={stats}>
                <Content />
            </LogLayout>
        </div>
    </div>
</BaseLayout>
